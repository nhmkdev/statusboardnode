<html>
<body>
<!-- TODO: favicon -->
<!-- Server populates the JQUERYSCRIPT with the contents specified in the config.js -->
<!--JQUERYSCRIPT-->
<script>
// TODO figure out how to share code between server and client

var updateRequester = null;
var updatePending = false;
// TODO: move all this to another script file

var boardId = window.location.pathname.replace('/', '').replace('/', '');

console.log('pathname:' + boardId);

var statusBoardData = null;

var FieldBuilder = {};

FieldBuilder.getTextObject = function(id, val)
{
    var obj =
    {
        i:id,
        t:'text',
        v:
        {
            t:val
        }
    };
    return obj;
}

FieldBuilder.getTextField = function(id)
{
    return FieldBuilder.getTextObject(id, document.getElementById(id).value);
}

function BrowserLayoutControl()
{
    this.controlMap = {};
    this.controlMap['text'] = this.addTextField;
}

BrowserLayoutControl.prototype.processUpdate = function(updateData)
{
    var htmlString = '';
    for(var idx = 0, len = updateData.s.length; idx < len; idx++)
    {
        var item = updateData.s[idx];
        var controlFunc = this.controlMap[item.t];
        if(typeof controlFunc !== 'undefined')
        {
            htmlString += controlFunc(item, idx, len);
        }
        else
        {

        }
    }
    document.getElementById('statusdata').innerHTML = htmlString;
}

BrowserLayoutControl.prototype.addTextField = function(item, index, length)
{
    var htmlData = '<input type="text" id="' + item.i + '" value="'+ item.v.t +'" onchange="pushUpdate(FieldBuilder.getTextField(\'' + item.i +'\'))"/>';
    // TODO: this will look weird so attempt to improve upon the visual
    if(index > 0)
    {
        htmlData = htmlData + '<input type="button" value="up" onclick="moveItem(\'' + item.i + '\', -1)">';
    }
    if(index < length - 1)
    {
        htmlData = htmlData + '<input type="button" value="down" onclick="moveItem(\'' + item.i + '\', 1)">';
    }
    htmlData = htmlData + '<input type="button" value="-" onclick="deleteItem(\'' + item.i + '\')"><br>';
    return htmlData;
}

var layoutControl = new BrowserLayoutControl();

function sendUpdate(forceUpdate)
{
    if(updatePending)
    {
        return;
    }
    
    updatePending = true;
    if(updateRequester != null)
    {
        clearTimeout(updateRequester);
    }

    if(!forceUpdate)
    {
        ajaxGETRequest({action:'getdataversion'},
            function(response, code, xhr)
            {
                updatePending = false;
                if(statusBoardData.v != response)
                {
                    // mismatched version, request full update
                    console.log('data version mismatch forcing update');
                    sendUpdate(true);
                }
                else
                {
                    console.log('data is up to date waiting...');
                    updateRequester = setTimeout(function() { sendUpdate(); }, 5000);
                }
            }
        );
    }
    else
    {
        ajaxGETRequest({action:'sendupdate'},
            function(response, code, xhr)
            {
                // TODO: this is a HAAAAACK and requires a bit more thought
                updatePending = false;
                try
                {
                    console.log('x:' + response);
                    // TODO: rethink the storage of this on the client (how and where)
                    statusBoardData = JSON.parse(response);
                    layoutControl.processUpdate(statusBoardData);
                }
                catch (e)
                {
                    console.error("Parsing error:", e);
                }
                updateRequester = setTimeout(function() { sendUpdate(); }, 5000);
            }
        );
    }
}

function pushUpdate(updateData)
{
    // TODO: maintain a client side copy of the status board object to simplify this...
    var obj = {};
    obj.s =
    [
        updateData
    ];

    ajaxPOSTRequest({ action:'pushitemupdate', data:obj},
        function(response, code, xhr)
        {
            // TODO...
            sendUpdate(true);
        }
    );
}

function addItem()
{
    // TODO: hard coded text creation...
    ajaxPOSTRequest({action:'additem', v: { t:'new item' }},
        function(response, code, xhr)
        {
            // TODO...
            sendUpdate(true);
        }
    );
}

function deleteItem(id)
{
    // TODO: hard coded text creation...
    ajaxPOSTRequest({action:'deleteitem', i:id},
            function(response, code, xhr)
            {
                // TODO...
                sendUpdate(true);
            }
    );
}

function moveItem(id, direction)
{
    ajaxPOSTRequest({action:'moveitem', i:id, d:direction},
            function(response, code, xhr)
            {
                // TODO...
                sendUpdate(true);
            }
    );
}

function ajaxGETRequest(data, success)
{
    $.ajax(
    {
        cache : false,
        // setup the server address
        type: 'GET',
        processData: true,
        url : window.location,
        data: data,
        success : success
    }
    );
}

function ajaxPOSTRequest(data, success)
{
    $.ajax(
    {
        cache : false,
        // setup the server address
        type: 'POST',
        processData: false,
        url : window.location,
        data: JSON.stringify(data),
        success : success
    }
    );
}

// TODO: consider long polling instead of periodic polling
// AJAX Abort http://stackoverflow.com/questions/446594/abort-ajax-requests-using-jquery

sendUpdate(true);
</script>

StatusBoard
<hr>
<div id="statusdata"></div>
<hr>
<div id="controls">
    <input type="text" id="newitemtext" value="New Item"/>
    <input type="button" value="+" onclick="addItem()">
</div>
</body>
</html>